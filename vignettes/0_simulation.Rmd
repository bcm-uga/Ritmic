---
title: "RiTMIC: RegulatIon of Tumor MIcroenvironment Composition"
subtitle: "Part 0 : Simulation of complex gene expression matrix"
author: "Clementine Decamps, Fabien Quinquis, Magali Richard"
contact: 
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
vignette: >
  %\VignetteIndexEntry{simulation}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=TRUE, results="verbatim", dpi=75)
layout(1, respect=TRUE)

if(!dir.exists("tmp_ritmic")){
  dir.create("tmp_ritmic")
}
```

`RiTMIC` (**R**egulat**I**on of **T**umor **MI**croenvironment **C**omposition) is an open-access R package to study the link between the gene expression in a tumor and the microenvironment composition.  

![](images/pipeline_ritmic.png)

The pipeline is in 4 steps:  

1. **Deconvolution** of the bulk samples to obtain the cell type composition.
2. **Extraction** of the cancer expression.
3. **Differential** analysis of the gene expression in the cancer component.
4. **Analyze** of the link between the gene expression in the cancer and the tumor composition.

---

Here we propose a pre-step of **simulation** (step 0) to obtain datasets compatible with the pipeline.

# Simulation of the cell type proportions (A)

The function `simu_A` simulates the cell type proportion matrix, with for each sample the proportion of each cell type. It's used a Dirichlet distribution, where the parameter `n` correspond to the number of samples and the parameter alpha to the average proportion of different cell types.

```{r, echo = F, eval = T}
cell_type_proportions = c(1.5, 4.5, 1, 3)
sample_size = 30
if(!file.exists("tmp_ritmic/A_matrix.rds")){
  A_matrix = Ritmic::simu_A(sample_size, cell_type_proportions)
  rownames(A_matrix) = c("Epi", "IC", "Fibroblast", "Tumor")
  saveRDS(A_matrix, file="tmp_ritmic/A_matrix.rds")
}
A_matrix = readRDS("tmp_ritmic/A_matrix.rds")
```

```{r, label="RiTMIC::simu_A", echo = T, eval = F}
cell_type_proportions = c(1.5, 4.5, 1, 3)
sample_size = 30
A_matrix = Ritmic::simu_A(n = sample_size, alpha = cell_type_proportions)
```

# Simulation of the cell line profiles (T)

In our simulations, we used a same A matrix for both DNAm and RNAseq data, but we need different T matrices.  
For the DNAm, we used one profile for each cell type.  
For the RNAseq, in order to simulate the variability due to cancer, we used a different profile for the tumor of each sample. The 3 cell types of the micro-environment are the same in each sample.

## DNAm cell type profiles

Here, the profiles of 4 cell types are simulated randomly (but we can use real cell line instead).

```{r, label="RiTMIC::simu_T_met"}
T_met = matrix(data = sample(seq(0, 1, 0.0001), size = 10000*4, replace = T), nrow = 10000, ncol = 4)
colnames(T_met) = c("Epi", "IC", "Fibroblast", "Tumor")
rownames(T_met) = 1:10000

if(!file.exists("tmp_ritmic/T_met.rds")){
  saveRDS(T_met, file = "tmp_ritmic/T_met.rds")
}

dim(T_met)
head(T_met)
```


## RNAseq microenvironment profiles

For the transcriptomic data, we simulated 3 cell types randomly for the microenvironment.

```{r, label="RiTMIC::simu_T_rna"}
T_rna = matrix(data = sample(seq(0, 5000, 0.1), size = 1000*3, replace = T), nrow = 1000, ncol = 3)
colnames(T_rna) = c("Epi", "IC", "Fibroblast")
rownames(T_rna) = rownames(penda::penda_data_case)[1:1000]

if(!file.exists("tmp_ritmic/T_rna.rds")){
  saveRDS(T_rna, file = "tmp_ritmic/T_rna.rds")
}

dim(T_rna)
head(T_rna)
```

## RNAseq cancer profiles

We want a different cancer profile in each sample. For that, we can used different cell lines, but also simulated news if needed. The function `simu_T_cancer` is made for that: for each gene, novel gene expressions will be assigned by a random choice inside the bimodal distribution of the actual gene expression. If we can't reach a bimodal distribution, we used one of the current gene expression randomly.

```{r, label="RiTMIC::simu_T_cancer"}
tumor_ref =  penda::penda_data_case[1:1000, 1:10]
dim(tumor_ref)

T_tum <- Ritmic::simu_T_cancer(tumor_ref, sample_size)
if(!file.exists("tmp_ritmic/T_tum.rds")){
  saveRDS(T_tum, file = "tmp_ritmic/T_tum.rds")
}

dim(T_tum)
head(T_tum)[, 1:5]
```

# Simulation of the deregulation of gene expression according to ME proportion in tumors

**To do** : Two methods to disturb the tumor micro environments are available by a random modification of the gene expressions  :  `corr_prop_f` and `corr_prop_t`.
Methods differ by the calcul of coefficients:

- `corr_prop_f`: newGeneExpression = geneExpression \* (1 + dereg_coeff \* cellTypeProportion))

- `corr_prop_t`: newGeneExpression = geneExpression \* dereg_coeff if thres > cellproportion

Explain here we used factor 


```{r, label="RiTMIC::corr_prop_f"}
T_tum_dereg = Ritmic::corr_prop_f(T_cancer = T_tum,A_ME = A_matrix[3, ], G = 50, dereg_coeff = 10)

T_tum_dereg$g_dereg

if(!file.exists("tmp_ritmic/T_tum_dereg.rds")){
  saveRDS(T_tum_dereg, file = "tmp_ritmic/T_tum_dereg.rds")
}
```

# Simulation of the bulk samples (D)

**To do** : explain D matrices

## DNAm

**To do** : comment

```{r, label="RiTMIC::simu_D_met"}
D_met = T_met %*% A_matrix

if(!file.exists("tmp_ritmic/D_met.rds")){
  saveRDS(D_met, file = "tmp_ritmic/D_met.rds")
}

dim(D_met)
head(D_met)[, 1:5]
```

## RNAseq

**To do** : comment

```{r, label="RiTMIC::simu_D"}
D_rna <- Ritmic::simu_D(A = A_matrix, T = T_rna, T_cancer = T_tum_dereg, noise = F)

if(!file.exists("tmp_ritmic/D_rna.rds")){
  saveRDS(D_rna, file = "tmp_ritmic/D_rna.rds")
}

dim(D_rna)
head(D_rna)[, 1:5]
```


# Session Information

```{r, results="verbatim"}
sessionInfo()
```